# /etc/nginx/conf.d/00-real-ip.conf
# Cloudflare Tunnel (X-Forwarded-For) からクライアントの
# 本当のIPアドレスを取得するための設定

# 1. IPアドレスが含まれるヘッダーを指定
real_ip_header X-Forwarded-For;

# 2. X-Forwarded-Forが複数のIPを含む場合（例: client, proxy1, proxy2）
#    信頼できるIP（Cloudflare）を除いた最後のIPをクライアントIPとして採用
real_ip_recursive on;

# 3. ログフォーマットの定義
#    'combined' フォーマットをベースに、'real_ip' モジュールで書き換えられた
#    $remote_addr を使用する
log_format combined_realip '$remote_addr - $remote_user [$time_local] ' '"$request" $status $body_bytes_sent ' '"$http_referer" "$http_user_agent"';
